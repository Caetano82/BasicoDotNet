# Docker Pipeline - Frontend React App
# Build and push Docker image for React Application to Azure Container Registry
# https://docs.microsoft.com/azure/devops/pipelines/languages/docker

trigger:
  branches:
    include:
      - master
      - main
  paths:
    include:
      - ReactApp/*
      - azure-pipelines-frontend.yml

resources:
  - repo: self

variables:
  # Nome do Service Connection AzureRM criado no Azure DevOps
  # ID do Service Connection: 9375e1a3-0899-4197-b6e6-857da1df01d7
  azureSubscription: 'conectaazure'
  # URL do Azure Container Registry
  containerRegistry: 'unewsistemas.azurecr.io'
  acrName: 'unewsistemas'
  frontendImageRepository: 'bernhoeft-react-app'
  tag: '$(Build.BuildId)'
  REACT_APP_API_URL: 'http://localhost:5001/api/v1'  # URL padrão da API

stages:
- stage: BuildFrontend
  displayName: Build and Push Frontend React App
  jobs:
  - job: BuildFrontend
    displayName: Build Frontend Docker Image
    pool:
      vmImage: ubuntu-latest
    steps:
    # Verificar Docker
    - script: |
        echo "Docker version:"
        docker --version
      displayName: 'Verificar Docker'

    # Login no Azure usando Service Connection AzureRM
    - task: AzureCLI@2
      displayName: 'Login no Azure e ACR'
      inputs:
        azureSubscription: '$(azureSubscription)'
        scriptType: 'bash'
        scriptLocation: 'inlineScript'
        inlineScript: |
          # Login no Azure Container Registry
          az acr login --name $(acrName)
          echo "Login no ACR realizado com sucesso"

    # Build da imagem Docker do Frontend
    - script: |
        docker build \
          --build-arg REACT_APP_API_URL=$(REACT_APP_API_URL) \
          -f ReactApp/Dockerfile \
          -t $(containerRegistry)/$(frontendImageRepository):$(tag) \
          -t $(containerRegistry)/$(frontendImageRepository):latest \
          ReactApp
      displayName: 'Build Frontend Docker Image'

    # Push da imagem Frontend para Azure Container Registry
    - script: |
        docker push $(containerRegistry)/$(frontendImageRepository):$(tag)
        docker push $(containerRegistry)/$(frontendImageRepository):latest
      displayName: 'Push Frontend Docker Image to ACR'

    # Salvar informações da imagem
    - script: |
        echo "##vso[task.setvariable variable=FrontendImageTag]$(containerRegistry)/$(frontendImageRepository):$(tag)"
        echo "Imagem Frontend construída e enviada: $(containerRegistry)/$(frontendImageRepository):$(tag)"
        echo "Registry: $(containerRegistry)"
        echo "Repository: $(frontendImageRepository)"
        echo "Tag: $(tag)"
      displayName: 'Salvar informações Frontend'

