# Docker Pipeline - Backend API e Frontend React
# Build Docker images for .NET API and React Application
# https://docs.microsoft.com/azure/devops/pipelines/languages/docker

trigger:
  branches:
    include:
      - master
      - main
  paths:
    include:
      - ReactApp/*
      - 1-Presentation/Bernhoeft.GRT.Teste.Api/*
      - 2-Application/*
      - 3-Domain/*
      - 4-Infra/*
      - azure-pipelines.yml

resources:
  - repo: self

variables:
  dockerRegistryServiceConnection: 'unewsistemas-acr-service-connection'  # Nome do Service Connection no Azure DevOps
  containerRegistry: 'unewsistemas.azurecr.io'
  backendImageRepository: 'unewsistemas.azurecr.io/bernhoeft-api'
  frontendImageRepository: 'unewsistemas.azurecr.io/bernhoeft-react-app'
  tag: '$(Build.BuildId)'
  REACT_APP_API_URL: 'http://localhost:5001/api/v1'  # URL padrão da API

stages:
- stage: BuildBackend
  displayName: Build Backend API
  jobs:
  - job: BuildBackend
    displayName: Build Backend Docker Image
    pool:
      vmImage: ubuntu-latest
    steps:
    # Verificar Docker
    - script: |
        echo "Docker version:"
        docker --version
      displayName: 'Verificar Docker'

    # Build da imagem Docker do Backend
    - task: Docker@2
      displayName: 'Build Backend Docker Image'
      inputs:
        command: build
        dockerfile: '1-Presentation/Bernhoeft.GRT.Teste.Api/Dockerfile'
        buildContext: '.'
        containerRegistry: '$(dockerRegistryServiceConnection)'
        repository: 'bernhoeft-api'
        tags: |
          $(tag)
          latest

    # Push da imagem Backend para Azure Container Registry
    - task: Docker@2
      displayName: 'Push Backend Docker Image to ACR'
      inputs:
        command: push
        containerRegistry: '$(dockerRegistryServiceConnection)'
        repository: 'bernhoeft-api'
        tags: |
          $(tag)
          latest

    # Salvar informações da imagem
    - script: |
        echo "##vso[task.setvariable variable=BackendImageTag]$(backendImageRepository):$(tag)"
        echo "Imagem Backend construída e enviada: $(backendImageRepository):$(tag)"
        echo "Registry: $(containerRegistry)"
      displayName: 'Salvar informações Backend'

- stage: BuildFrontend
  displayName: Build Frontend React App
  jobs:
  - job: BuildFrontend
    displayName: Build Frontend Docker Image
    pool:
      vmImage: ubuntu-latest
    steps:
    # Verificar Docker
    - script: |
        echo "Docker version:"
        docker --version
      displayName: 'Verificar Docker'

    # Build da imagem Docker do Frontend
    - task: Docker@2
      displayName: 'Build Frontend Docker Image'
      inputs:
        command: build
        dockerfile: 'ReactApp/Dockerfile'
        buildContext: 'ReactApp'
        arguments: '--build-arg REACT_APP_API_URL=$(REACT_APP_API_URL)'
        containerRegistry: '$(dockerRegistryServiceConnection)'
        repository: 'bernhoeft-react-app'
        tags: |
          $(tag)
          latest

    # Push da imagem Frontend para Azure Container Registry
    - task: Docker@2
      displayName: 'Push Frontend Docker Image to ACR'
      inputs:
        command: push
        containerRegistry: '$(dockerRegistryServiceConnection)'
        repository: 'bernhoeft-react-app'
        tags: |
          $(tag)
          latest

    # Salvar informações da imagem
    - script: |
        echo "##vso[task.setvariable variable=FrontendImageTag]$(frontendImageRepository):$(tag)"
        echo "Imagem Frontend construída e enviada: $(frontendImageRepository):$(tag)"
        echo "Registry: $(containerRegistry)"
      displayName: 'Salvar informações Frontend'
